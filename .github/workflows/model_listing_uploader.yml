name: Model Listing Uploading
on:
  push:
    branches: # TO-BE-CHANGED
     - workflow-for-review 
     - experiment-description
    paths: 
     - utils/model_uploader/model_listing/pretrained_model_listing.json
  
jobs:
  upload-model-listing:
    runs-on: 'ubuntu-latest'
    permissions:
      id-token: write
      contents: read
    environment: opensearch-py-ml-cicd-env
    env:
      bucket_model_listing_file_path: ml-models/model_listing/pre_trained_models.json
      repo_model_listing_path: ./utils/model_uploader/model_listing/pretrained_model_listing.json
    steps:
#     - name: Fail if branch is not main
#       if: github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
#       run: |
#          echo "This workflow should only be triggered on a default branch"
#          exit 1
    - name: Checkout Repository
      uses: actions/checkout@v3
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-region: ${{ secrets.PERSONAL_MODEL_UPLOADER_AWS_REGION }}
        role-to-assume: ${{ secrets.PERSONAL_MODEL_UPLOADER_ROLE }}
        role-session-name: upload-model-listing
    - name: Update pre_trained_models.json in S3
      run: aws s3 cp ${{ env.repo_model_listing_path }} s3://${{ secrets.PERSONAL_MODEL_BUCKET }}/${{ env.bucket_model_listing_file_path }}

# # TODO: Trigger Jenkins Workflow
#   trigger-model-release-workflow:
#     runs-on: 'ubuntu-latest'
#     steps:
#       - name: Trigger Jenkins Workflow with Generic Webhook
#         run: |
#           JENKINS_URL="https://build.ci.opensearch.org"
#           JENKINS_TRIGGER_TOKEN=${{ secrets.JENKINS_ML_MODELS_RELEASE_GENERIC_WEBHOOK_TOKEN }}
          
#           JENKINS_PARAMS="{\"BASE_DOWNLOAD_PATH\":\"ml-models/model_listing\"}"
          
#           # TODO: Set up JENKINS_TRIGGER_TOKEN
#           JENKINS_REQ=`curl -s -XPOST \
#              -H "Authorization: Bearer $JENKINS_TRIGGER_TOKEN" \
#              -H "Content-Type: application/json" \
#              "$JENKINS_URL/generic-webhook-trigger/invoke" \
#              --data "$(echo $JENKINS_PARAMS)"`

#           echo $JENKINS_REQ
